<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier Dashboard - Hotel Vijay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print { .no-print { display: none !important; } .kot-card { border: 1px solid black; width: 300px; padding: 15px; font-family: monospace; } }
        .blink-red { animation: blinker 1s linear infinite; background-color: #450a0a !important; border: 3px solid #ef4444 !important; }
        @keyframes blinker { 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-slate-900 text-white p-6 font-sans">

    <div id="sound-unlocker" class="fixed inset-0 bg-slate-950 z-[200] flex flex-col items-center justify-center text-center px-4">
        <div class="text-7xl mb-6">üîï</div>
        <h2 class="text-3xl font-black text-white mb-2 uppercase italic tracking-widest text-orange-500">System Offline</h2>
        <p class="text-slate-400 mb-10 text-sm font-bold max-w-sm">Naye orders receive karne aur Notification Sound chalu karne ke liye niche click karein. (Tab minimize hone par bhi sound aayegi)</p>
        <button onclick="startSystem()" class="bg-green-600 hover:bg-green-500 px-10 py-5 rounded-[2rem] text-white font-black text-xl shadow-[0_0_30px_rgba(22,163,74,0.5)] animate-bounce active:scale-95 transition-all">
            üîä START SYSTEM NOW
        </button>
    </div>

    <div class="max-w-7xl mx-auto flex justify-between items-center mb-6 border-b border-slate-800 pb-6 no-print">
        <div>
            <h1 class="text-4xl font-black text-orange-500 italic uppercase">Hotel Vijay</h1>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.3em]">Growft Kitchen Management</p>
        </div>
        <div id="status-indicator" class="flex items-center gap-3 bg-slate-800 px-6 py-3 rounded-2xl border border-slate-700">
            <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
            <span class="text-xs font-black uppercase tracking-widest">System Live & Sound Active</span>
        </div>
    </div>

    <div class="max-w-7xl mx-auto flex gap-4 mb-8 no-print border-b border-slate-800 pb-4">
        <button onclick="switchTab('orders')" id="tab-orders" class="bg-orange-600 px-8 py-3 rounded-2xl font-black shadow-lg shadow-orange-900/50 transition-all text-sm uppercase tracking-widest">Live Orders</button>
        <button onclick="switchTab('analytics')" id="tab-analytics" class="bg-slate-800 hover:bg-slate-700 px-8 py-3 rounded-2xl font-black text-slate-400 transition-all text-sm uppercase tracking-widest">Sales Report</button>
    </div>

    <div id="orders-grid" class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 no-print">
        <div class="text-center col-span-full py-20 text-slate-700 font-bold animate-pulse">Waiting for new orders...</div>
    </div>

    <div id="analytics-section" class="max-w-7xl mx-auto hidden no-print">
        <div class="bg-slate-800 p-6 rounded-3xl mb-8 flex flex-wrap gap-4 items-end border border-slate-700 shadow-xl">
            <div>
                <label class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2 block">Start Date</label>
                <input type="date" id="start-date" class="bg-slate-900 text-white p-4 rounded-xl border border-slate-600 outline-none font-bold">
            </div>
            <div>
                <label class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2 block">End Date</label>
                <input type="date" id="end-date" class="bg-slate-900 text-white p-4 rounded-xl border border-slate-600 outline-none font-bold">
            </div>
            <button onclick="generateReport()" class="bg-green-600 hover:bg-green-500 px-8 py-4 rounded-xl font-black transition-all shadow-lg active:scale-95 text-sm uppercase tracking-widest">
                üìä Fetch Sales
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-xl flex justify-between items-center">
                <div>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Total Revenue</p>
                    <h2 id="report-total-revenue" class="text-5xl font-black text-green-500">‚Çπ0</h2>
                </div>
                <div class="text-5xl opacity-20">üí∞</div>
            </div>
            <div class="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-xl flex justify-between items-center">
                <div>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Total Orders</p>
                    <h2 id="report-total-orders" class="text-5xl font-black text-blue-400">0</h2>
                </div>
                <div class="text-5xl opacity-20">üì¶</div>
            </div>
        </div>

        <div class="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-xl">
            <h3 class="font-black text-xl mb-6 text-orange-500 uppercase tracking-widest border-b border-slate-700 pb-4">Item-wise Sales Ratio</h3>
            <div id="item-sales-list" class="space-y-6">
                <p class="text-slate-500 text-sm font-bold text-center py-10">Select dates and click "Fetch Sales" to see the breakdown...</p>
            </div>
        </div>
    </div>

    <div id="print-area" class="w-full"></div>

    <script>
        // ==========================================
        // YAHAN APNA MASTER SCRIPT URL DALNA HAI
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFZXiQ9c1CPbJ6Js0o6HtIt4mEIRigzAI6CxgXKLId5fOy3VCoLBZC_F4DAspf1h4EsA/exec";
        
        let lastOrderCount = 0;
        let allRawOrders = []; 
        let systemActive = false;
        
        // üîä Sound Object
        const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        // ‚ú® NAYA: SYSTEM START FUNCTION (Unlocks Audio)
        function startSystem() {
            // Browser ko trick karke audio permission leni hoti hai
            alertSound.play().then(() => {
                alertSound.pause();
                alertSound.currentTime = 0;
            }).catch(e => console.log("Audio unlock failed", e));
            
            document.getElementById('sound-unlocker').classList.add('hidden');
            systemActive = true;
            
            // Ab checking chalu karo
            fetchOrders();
            setInterval(fetchOrders, 7000);
        }

        function switchTab(tab) {
            document.getElementById('orders-grid').classList.toggle('hidden', tab !== 'orders');
            document.getElementById('analytics-section').classList.toggle('hidden', tab !== 'analytics');
            document.getElementById('tab-orders').className = tab === 'orders' ? 'bg-orange-600 px-8 py-3 rounded-2xl font-black shadow-lg shadow-orange-900/50 transition-all text-sm uppercase tracking-widest' : 'bg-slate-800 hover:bg-slate-700 px-8 py-3 rounded-2xl font-black text-slate-400 transition-all text-sm uppercase tracking-widest';
            document.getElementById('tab-analytics').className = tab === 'analytics' ? 'bg-orange-600 px-8 py-3 rounded-2xl font-black shadow-lg shadow-orange-900/50 transition-all text-sm uppercase tracking-widest' : 'bg-slate-800 hover:bg-slate-700 px-8 py-3 rounded-2xl font-black text-slate-400 transition-all text-sm uppercase tracking-widest';
        }

        async function fetchOrders() {
            if(!systemActive) return; // Bina permission ke request nahi jayegi
            
            try {
                const res = await fetch(SCRIPT_URL + "?t=" + new Date().getTime());
                allRawOrders = await res.json();
                
                const validOrders = allRawOrders.filter(o => o.invoice_no && o.status !== "Served" && o.status !== "Rejected").reverse();
                
                // üîä Agar naya order hai, toh bajao sound!
                if (validOrders.length > lastOrderCount && lastOrderCount !== 0) {
                    alertSound.play().catch(e => console.log("Still blocking audio:", e));
                }
                lastOrderCount = validOrders.length;
                
                renderOrders(validOrders);
            } catch (e) { console.log("Fetch Error"); }
        }

        function renderOrders(orders) {
            const grid = document.getElementById('orders-grid');
            if(orders.length === 0) {
                grid.innerHTML = '<div class="text-center col-span-full py-20 text-slate-700 font-bold animate-pulse">No Active Orders...</div>';
                return;
            }
            
            grid.innerHTML = orders.map(order => {
                const isAsked = order.query_status === "Asked";
                const cardClass = isAsked ? "bg-slate-800 p-6 rounded-[2.5rem] border-2 blink-red" : "bg-slate-800 p-6 rounded-[2.5rem] border border-slate-700";
                
                let buttonsHtml = '';
                if (order.status === 'Pending') {
                    buttonsHtml = `<button onclick="updateStatus('${order.invoice_no}', 'Preparing')" class="bg-green-600 hover:bg-green-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">‚úÖ Accept</button>
                                   <button onclick="updateStatus('${order.invoice_no}', 'Rejected')" class="bg-red-600 hover:bg-red-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">‚ùå Reject</button>`;
                } else if (order.status === 'Preparing') {
                    buttonsHtml = `<button onclick="updateStatus('${order.invoice_no}', 'Ready')" class="col-span-2 bg-blue-600 hover:bg-blue-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">üç≤ Mark Ready</button>`;
                } else if (order.status === 'Ready') {
                    buttonsHtml = `<button onclick="updateStatus('${order.invoice_no}', 'Served')" class="col-span-2 bg-purple-600 hover:bg-purple-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">üèÅ Order Completed</button>`;
                }

                return `
                <div class="${cardClass} transition-all duration-500 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <span class="bg-orange-600/20 text-orange-500 text-[10px] px-3 py-1 rounded-full font-black uppercase">Table ${order.table_no}</span>
                        <span class="text-[10px] text-slate-500 font-bold">#${order.invoice_no}</span>
                    </div>
                    <h2 class="text-xl font-black truncate mb-1">${order.customer_name}</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-4">Status: <span class="text-white">${order.status}</span></p>
                    <div class="bg-slate-900/50 p-4 rounded-2xl mb-6 min-h-[80px] text-sm font-bold text-orange-50/80 leading-relaxed border border-slate-700/30">
                        ${order.items}
                    </div>
                    <div class="grid grid-cols-2 gap-2 no-print">
                        ${buttonsHtml}
                        <button onclick='printProperKOT("${order.invoice_no}", "${order.customer_name}", "${order.table_no}", \`${order.items}\`)' class="col-span-2 bg-slate-700 hover:bg-slate-600 p-2 rounded-xl text-[10px] font-black uppercase mt-2 border border-slate-600">üñ®Ô∏è Print KOT</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function updateStatus(inv, newStatus) {
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "update", invoice_no: inv, new_status: newStatus }) });
                fetchOrders(); 
            } catch (e) { alert("Update failed!"); }
        }

        // KOT aur Report generate karne wale functions wahi purane wale hain (chupaye gaye hain taaki code lamba na ho)
        function printProperKOT(inv, name, table, itemsString) {
            const printArea = document.getElementById('print-area');
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }).toLowerCase();
            let itemsHtml = ''; let totalQty = 0; let count = 1;
            if (itemsString) {
                const parts = itemsString.split(',');
                parts.forEach(p => {
                    const match = p.match(/(.+?)\s*\((\d+)\)/);
                    if (match) {
                        const itemName = match[1].trim().toUpperCase(); const qty = parseInt(match[2]); totalQty += qty;
                        itemsHtml += `<tr><td style="padding: 4px 0; border-bottom: 1px dotted #000; font-size: 13px;">${count}</td><td style="padding: 4px 0; border-bottom: 1px dotted #000; font-size: 13px;">${itemName}</td><td style="padding: 4px 0; border-bottom: 1px dotted #000; text-align: center; font-size: 13px;">QTY</td><td style="padding: 4px 0; border-bottom: 1px dotted #000; text-align: right; font-weight: bold; font-size: 14px;">${qty}</td></tr>`;
                        count++;
                    }
                });
            }
            printArea.innerHTML = `<div style="width: 300px; font-family: 'Courier New', Courier, monospace; color: #000; background: #fff; padding: 10px;"><h3 style="text-align: center; margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">HOTEL VIJAY<br><span style="font-size: 14px;">Kitchen</span></h3><div style="font-size: 13px; line-height: 1.6; margin-bottom: 10px;"><div style="display: flex; justify-content: space-between;"><div><b>Date :</b> ${dateStr}-${timeStr}</div></div><div style="display: flex; justify-content: space-between;"><div><b>Kot #</b> ${inv}</div><div><b>Type :</b> Dine-in</div></div><div style="display: flex; justify-content: space-between;"><div><b>Customer:</b> ${name}</div><div><b>Table:</b> ${table}</div></div><div style="display: flex; justify-content: space-between;"><div><b>Waiter:</b> QR/Online</div></div></div><h4 style="text-align: center; margin: 10px 0; font-size: 16px; border-bottom: 2px solid #000; font-weight: bold;">KOT</h4><table style="width: 100%; border-collapse: collapse; text-align: left; margin-bottom: 5px;"><thead><tr style="border-bottom: 1px dashed #000; font-size: 14px;"><th style="padding-bottom: 5px; width: 10%;">#</th><th style="padding-bottom: 5px; width: 55%;">Product</th><th style="padding-bottom: 5px; text-align: center; width: 20%;">Uom</th><th style="padding-bottom: 5px; text-align: right; width: 15%;">Qty</th></tr></thead><tbody>${itemsHtml}</tbody></table><div style="display: flex; justify-content: flex-end; margin-top: 5px;"><div style="border: 1px solid #000; padding: 2px 10px; font-weight: bold; font-size: 15px; display: flex; gap: 40px;"><span>Total :</span><span>${totalQty}</span></div></div><div style="text-align: right; font-size: 11px; margin-top: 10px;">User: ADMIN</div></div>`;
            window.print();
        }

        function generateReport() {
            const startDateStr = document.getElementById('start-date').value; const endDateStr = document.getElementById('end-date').value;
            let completedOrders = allRawOrders.filter(o => o.status === "Served");
            if(startDateStr && endDateStr) {
                const start = new Date(startDateStr); start.setHours(0,0,0,0);
                const end = new Date(endDateStr); end.setHours(23,59,59,999);
                completedOrders = completedOrders.filter(o => { if(!o.timestamp) return true; const orderDate = new Date(o.timestamp); return orderDate >= start && orderDate <= end; });
            }
            let totalRevenue = 0, itemCounts = {}, totalItemsSold = 0;
            completedOrders.forEach(order => {
                totalRevenue += parseFloat(order.total_amount) || 0;
                if(order.items) {
                    order.items.split(',').forEach(p => {
                        const match = p.match(/(.+?)\s*\((\d+)\)/);
                        if(match) { const name = match[1].trim(); const qty = parseInt(match[2]); itemCounts[name] = (itemCounts[name] || 0) + qty; totalItemsSold += qty; }
                    });
                }
            });
            document.getElementById('report-total-revenue').innerText = "‚Çπ" + totalRevenue; document.getElementById('report-total-orders').innerText = completedOrders.length;
            const itemListHtml = Object.keys(itemCounts).sort((a,b) => itemCounts[b] - itemCounts[a]).map(itemName => {
                const qty = itemCounts[itemName]; const percentage = totalItemsSold > 0 ? ((qty / totalItemsSold) * 100).toFixed(1) : 0;
                return `<div class="mb-4"><div class="flex justify-between text-sm font-bold mb-2"><span>${itemName}</span><span class="text-orange-400">${qty} Sold <span class="text-slate-500 text-xs ml-1">(${percentage}%)</span></span></div><div class="w-full bg-slate-700/50 rounded-full h-3 border border-slate-700"><div class="bg-gradient-to-r from-orange-600 to-orange-400 h-3 rounded-full shadow-[0_0_10px_rgba(234,88,12,0.5)]" style="width: ${percentage}%"></div></div></div>`;
            }).join('');
            document.getElementById('item-sales-list').innerHTML = itemListHtml || '<p class="text-slate-500 text-sm font-bold text-center py-10">Is date range mein koi order complete nahi hua.</p>';
        }
    </script>
</body>
</html>
