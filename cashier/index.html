<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier Dashboard - Hotel Vijay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print { .no-print { display: none !important; } .kot-card { border: 1px solid black; width: 300px; padding: 15px; font-family: monospace; } }
        .blink-red { animation: blinker 1s linear infinite; background-color: #450a0a !important; border: 3px solid #ef4444 !important; }
        @keyframes blinker { 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-slate-900 text-white p-6 font-sans">

    <div class="max-w-7xl mx-auto flex justify-between items-center mb-6 border-b border-slate-800 pb-6 no-print">
        <div>
            <h1 class="text-4xl font-black text-orange-500 italic uppercase">Hotel Vijay</h1>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.3em]">Growft Kitchen Management</p>
        </div>
        <div id="status-indicator" class="flex items-center gap-3 bg-slate-800 px-6 py-3 rounded-2xl border border-slate-700">
            <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
            <span class="text-xs font-black uppercase tracking-widest">System Live</span>
        </div>
    </div>

    <div class="max-w-7xl mx-auto flex gap-4 mb-8 no-print border-b border-slate-800 pb-4">
        <button onclick="switchTab('orders')" id="tab-orders" class="bg-orange-600 px-8 py-3 rounded-2xl font-black shadow-lg shadow-orange-900/50 transition-all text-sm uppercase tracking-widest">Live Orders</button>
        <button onclick="switchTab('analytics')" id="tab-analytics" class="bg-slate-800 hover:bg-slate-700 px-8 py-3 rounded-2xl font-black text-slate-400 transition-all text-sm uppercase tracking-widest">Sales Report</button>
    </div>

    <div id="orders-grid" class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 no-print">
        <div class="text-center col-span-full py-20 text-slate-700 font-bold animate-pulse">Waiting for new orders...</div>
    </div>

    <div id="analytics-section" class="max-w-7xl mx-auto hidden no-print">
        
        <div class="bg-slate-800 p-6 rounded-3xl mb-8 flex flex-wrap gap-4 items-end border border-slate-700 shadow-xl">
            <div>
                <label class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2 block">Start Date</label>
                <input type="date" id="start-date" class="bg-slate-900 text-white p-4 rounded-xl border border-slate-600 outline-none font-bold">
            </div>
            <div>
                <label class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2 block">End Date</label>
                <input type="date" id="end-date" class="bg-slate-900 text-white p-4 rounded-xl border border-slate-600 outline-none font-bold">
            </div>
            <button onclick="generateReport()" class="bg-green-600 hover:bg-green-500 px-8 py-4 rounded-xl font-black transition-all shadow-lg active:scale-95 text-sm uppercase tracking-widest">
                üìä Fetch Sales
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-xl flex justify-between items-center">
                <div>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Total Revenue</p>
                    <h2 id="report-total-revenue" class="text-5xl font-black text-green-500">‚Çπ0</h2>
                </div>
                <div class="text-5xl opacity-20">üí∞</div>
            </div>
            <div class="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-xl flex justify-between items-center">
                <div>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Total Orders Completed</p>
                    <h2 id="report-total-orders" class="text-5xl font-black text-blue-400">0</h2>
                </div>
                <div class="text-5xl opacity-20">üì¶</div>
            </div>
        </div>

        <div class="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-xl">
            <h3 class="font-black text-xl mb-6 text-orange-500 uppercase tracking-widest border-b border-slate-700 pb-4">Item-wise Sales Ratio</h3>
            <div id="item-sales-list" class="space-y-6">
                <p class="text-slate-500 text-sm font-bold text-center py-10">Select dates and click "Fetch Sales" to see the breakdown...</p>
            </div>
        </div>
    </div>

    <div id="print-area" class="hidden"></div>

    <script>
        // ==========================================
        // YAHAN APNA MASTER SCRIPT URL DALNA HAI
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFZXiQ9c1CPbJ6Js0o6HtIt4mEIRigzAI6CxgXKLId5fOy3VCoLBZC_F4DAspf1h4EsA/exec";
        
        let lastOrderCount = 0;
        let allRawOrders = []; // Analytics ke liye saara data yahan store hoga
        const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        // üîÑ Tab Switch Function
        function switchTab(tab) {
            document.getElementById('orders-grid').classList.toggle('hidden', tab !== 'orders');
            document.getElementById('analytics-section').classList.toggle('hidden', tab !== 'analytics');
            
            document.getElementById('tab-orders').className = tab === 'orders' ? 'bg-orange-600 px-8 py-3 rounded-2xl font-black shadow-lg shadow-orange-900/50 transition-all text-sm uppercase tracking-widest' : 'bg-slate-800 hover:bg-slate-700 px-8 py-3 rounded-2xl font-black text-slate-400 transition-all text-sm uppercase tracking-widest';
            
            document.getElementById('tab-analytics').className = tab === 'analytics' ? 'bg-orange-600 px-8 py-3 rounded-2xl font-black shadow-lg shadow-orange-900/50 transition-all text-sm uppercase tracking-widest' : 'bg-slate-800 hover:bg-slate-700 px-8 py-3 rounded-2xl font-black text-slate-400 transition-all text-sm uppercase tracking-widest';
        }

        async function fetchOrders() {
            try {
                const res = await fetch(SCRIPT_URL + "?t=" + new Date().getTime());
                allRawOrders = await res.json();
                
                // Sirf Pending aur Preparing wale orders grid me dikhenge
                const validOrders = allRawOrders.filter(o => o.invoice_no && o.status !== "Served" && o.status !== "Rejected").reverse();
                
                if (validOrders.length > lastOrderCount && lastOrderCount !== 0) {
                    alertSound.play().catch(e => console.log("Audio needs interaction"));
                }
                lastOrderCount = validOrders.length;
                
                renderOrders(validOrders);
            } catch (e) { console.log("Fetch Error"); }
        }

        function renderOrders(orders) {
            const grid = document.getElementById('orders-grid');
            if(orders.length === 0) {
                grid.innerHTML = '<div class="text-center col-span-full py-20 text-slate-700 font-bold animate-pulse">No Active Orders...</div>';
                return;
            }
            
            grid.innerHTML = orders.map(order => {
                const isAsked = order.query_status === "Asked";
                const cardClass = isAsked ? "bg-slate-800 p-6 rounded-[2.5rem] border-2 blink-red" : "bg-slate-800 p-6 rounded-[2.5rem] border border-slate-700";
                
                let buttonsHtml = '';
                if (order.status === 'Pending') {
                    buttonsHtml = `
                        <button onclick="updateStatus('${order.invoice_no}', 'Preparing')" class="bg-green-600 hover:bg-green-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">‚úÖ Accept</button>
                        <button onclick="updateStatus('${order.invoice_no}', 'Rejected')" class="bg-red-600 hover:bg-red-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">‚ùå Reject</button>
                    `;
                } else if (order.status === 'Preparing') {
                    buttonsHtml = `
                        <button onclick="updateStatus('${order.invoice_no}', 'Ready')" class="col-span-2 bg-blue-600 hover:bg-blue-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">üç≤ Mark Ready</button>
                    `;
                } else if (order.status === 'Ready') {
                    buttonsHtml = `
                        <button onclick="updateStatus('${order.invoice_no}', 'Served')" class="col-span-2 bg-purple-600 hover:bg-purple-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">üèÅ Order Completed</button>
                    `;
                }

                return `
                <div class="${cardClass} transition-all duration-500 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <span class="bg-orange-600/20 text-orange-500 text-[10px] px-3 py-1 rounded-full font-black uppercase">Table ${order.table_no}</span>
                        <span class="text-[10px] text-slate-500 font-bold">#${order.invoice_no}</span>
                    </div>

                    <h2 class="text-xl font-black truncate mb-1">${order.customer_name}</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-4">Status: <span class="text-white">${order.status}</span></p>

                    <div class="bg-slate-900/50 p-4 rounded-2xl mb-6 min-h-[80px] text-sm font-bold text-orange-50/80 leading-relaxed border border-slate-700/30">
                        ${order.items}
                    </div>

                    <div class="grid grid-cols-2 gap-2 no-print">
                        ${buttonsHtml}
                        <button onclick="printKOT('${order.invoice_no}', '${order.customer_name}', '${order.table_no}', '${order.items}')" class="col-span-2 bg-slate-700 hover:bg-slate-600 p-2 rounded-xl text-[10px] font-black uppercase mt-2 border border-slate-600">üñ®Ô∏è Print KOT</button>
                    </div>

                    ${isAsked ? '<div class="absolute top-2 right-2 animate-bounce bg-red-600 text-[8px] px-2 py-1 rounded font-black">CUSTOMER ASKING!</div>' : ''}
                </div>`;
            }).join('');
        }

        // üìä SALES REPORT GENERATOR
        function generateReport() {
            const startDateStr = document.getElementById('start-date').value;
            const endDateStr = document.getElementById('end-date').value;
            
            // Sirf "Served" (Completed) orders ko hi count karenge
            let completedOrders = allRawOrders.filter(o => o.status === "Served");
            
            // Date logic (Agar Google sheet me timestamp hai toh filter karega)
            if(startDateStr && endDateStr) {
                const start = new Date(startDateStr);
                start.setHours(0,0,0,0);
                const end = new Date(endDateStr);
                end.setHours(23,59,59,999);
                
                completedOrders = completedOrders.filter(o => {
                    if(!o.timestamp) return true; // Agar Sheet se date nahi aa rahi toh sab dikha dega
                    const orderDate = new Date(o.timestamp);
                    return orderDate >= start && orderDate <= end;
                });
            }

            let totalRevenue = 0;
            let itemCounts = {};
            let totalItemsSold = 0;

            completedOrders.forEach(order => {
                totalRevenue += parseFloat(order.total_amount) || 0;
                
                // Strings break karna (e.g., "Masala Papad (2), Paneer (1)")
                if(order.items) {
                    const parts = order.items.split(',');
                    parts.forEach(p => {
                        const match = p.match(/(.+?)\s*\((\d+)\)/); // Naam aur Quantity alag nikalna
                        if(match) {
                            const name = match[1].trim();
                            const qty = parseInt(match[2]);
                            itemCounts[name] = (itemCounts[name] || 0) + qty;
                            totalItemsSold += qty;
                        }
                    });
                }
            });

            // Update UI
            document.getElementById('report-total-revenue').innerText = "‚Çπ" + totalRevenue;
            document.getElementById('report-total-orders').innerText = completedOrders.length;

            // Generate Progress Bars for Items
            const itemListHtml = Object.keys(itemCounts).sort((a,b) => itemCounts[b] - itemCounts[a]).map(itemName => {
                const qty = itemCounts[itemName];
                const percentage = totalItemsSold > 0 ? ((qty / totalItemsSold) * 100).toFixed(1) : 0;
                return `
                <div class="mb-4">
                    <div class="flex justify-between text-sm font-bold mb-2">
                        <span>${itemName}</span>
                        <span class="text-orange-400">${qty} Sold <span class="text-slate-500 text-xs ml-1">(${percentage}%)</span></span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-3 border border-slate-700">
                        <div class="bg-gradient-to-r from-orange-600 to-orange-400 h-3 rounded-full shadow-[0_0_10px_rgba(234,88,12,0.5)]" style="width: ${percentage}%"></div>
                    </div>
                </div>
                `;
            }).join('');

            document.getElementById('item-sales-list').innerHTML = itemListHtml || '<p class="text-slate-500 text-sm font-bold text-center py-10">Is date range mein koi order complete nahi hua.</p>';
        }

        async function updateStatus(inv, newStatus) {
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ action: "update", invoice_no: inv, new_status: newStatus })
                });
                fetchOrders(); 
            } catch (e) { alert("Update failed!"); }
        }

        function printKOT(inv, name, table, items) { /* Same Code */ }
        document.body.addEventListener('click', () => alertSound.play().then(() => alertSound.pause()), {once: true});
        setInterval(fetchOrders, 7000);
        fetchOrders();
    </script>
</body>
</html>
