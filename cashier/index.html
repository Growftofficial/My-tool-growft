<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier Dashboard - Hotel Vijay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print { .no-print { display: none !important; } .kot-card { border: 1px solid black; width: 300px; padding: 15px; font-family: monospace; } }
        .blink-red { animation: blinker 1s linear infinite; background-color: #450a0a !important; border: 3px solid #ef4444 !important; }
        @keyframes blinker { 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-slate-900 text-white p-6">

    <div class="max-w-7xl mx-auto flex justify-between items-center mb-8 border-b border-slate-800 pb-6 no-print">
        <div>
            <h1 class="text-4xl font-black text-orange-500 italic uppercase">Hotel Vijay</h1>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.3em]">Growft Kitchen Management</p>
        </div>
        <div id="status-indicator" class="flex items-center gap-3 bg-slate-800 px-6 py-3 rounded-2xl border border-slate-700">
            <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
            <span class="text-xs font-black uppercase tracking-widest">System Live (Audio On)</span>
        </div>
    </div>

    <div id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 no-print">
        <div class="text-center col-span-full py-20 text-slate-700 font-bold animate-pulse">Waiting for new orders...</div>
    </div>

    <div id="print-area" class="hidden"></div>

    <script>
        // ==========================================
        // YAHAN APNA MASTER SCRIPT URL DALNA HAI
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFZXiQ9c1CPbJ6Js0o6HtIt4mEIRigzAI6CxgXKLId5fOy3VCoLBZC_F4DAspf1h4EsA/exec";
        
        let lastOrderCount = 0;
        const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        async function fetchOrders() {
            try {
                const res = await fetch(SCRIPT_URL + "?t=" + new Date().getTime());
                const data = await res.json();
                
                // NAYA LOGIC: 'Served' aur 'Rejected' orders cashier screen se hat jayenge
                const validOrders = data.filter(o => o.invoice_no && o.status !== "Served" && o.status !== "Rejected").reverse();
                
                if (validOrders.length > lastOrderCount && lastOrderCount !== 0) {
                    alertSound.play().catch(e => console.log("Audio needs interaction"));
                }
                lastOrderCount = validOrders.length;
                
                renderOrders(validOrders);
            } catch (e) { console.log("Fetch Error"); }
        }

        function renderOrders(orders) {
            const grid = document.getElementById('orders-grid');
            if(orders.length === 0) {
                grid.innerHTML = '<div class="text-center col-span-full py-20 text-slate-700 font-bold animate-pulse">No Active Orders...</div>';
                return;
            }
            
            grid.innerHTML = orders.map(order => {
                const isAsked = order.query_status === "Asked";
                const cardClass = isAsked ? "bg-slate-800 p-6 rounded-[2.5rem] border-2 blink-red" : "bg-slate-800 p-6 rounded-[2.5rem] border border-slate-700";
                
                // NAYA LOGIC: Status ke hisaab se alag-alag buttons dikhenge
                let buttonsHtml = '';
                if (order.status === 'Pending') {
                    buttonsHtml = `
                        <button onclick="updateStatus('${order.invoice_no}', 'Preparing')" class="bg-green-600 hover:bg-green-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">‚úÖ Accept</button>
                        <button onclick="updateStatus('${order.invoice_no}', 'Rejected')" class="bg-red-600 hover:bg-red-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">‚ùå Reject</button>
                    `;
                } else if (order.status === 'Preparing') {
                    buttonsHtml = `
                        <button onclick="updateStatus('${order.invoice_no}', 'Ready')" class="col-span-2 bg-blue-600 hover:bg-blue-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">üç≤ Mark Ready</button>
                    `;
                } else if (order.status === 'Ready') {
                    buttonsHtml = `
                        <button onclick="updateStatus('${order.invoice_no}', 'Served')" class="col-span-2 bg-purple-600 hover:bg-purple-700 p-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95">üèÅ Order Completed</button>
                    `;
                }

                return `
                <div class="${cardClass} transition-all duration-500 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <span class="bg-orange-600/20 text-orange-500 text-[10px] px-3 py-1 rounded-full font-black uppercase">Table ${order.table_no}</span>
                        <span class="text-[10px] text-slate-500 font-bold">#${order.invoice_no}</span>
                    </div>

                    <h2 class="text-xl font-black truncate mb-1">${order.customer_name}</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-4">Status: <span class="text-white">${order.status}</span></p>

                    <div class="bg-slate-900/50 p-4 rounded-2xl mb-6 min-h-[80px] text-sm font-bold text-orange-50/80 leading-relaxed border border-slate-700/30">
                        ${order.items}
                    </div>

                    <div class="grid grid-cols-2 gap-2 no-print">
                        ${buttonsHtml}
                        <button onclick="printKOT('${order.invoice_no}', '${order.customer_name}', '${order.table_no}', '${order.items}')" class="col-span-2 bg-slate-700 hover:bg-slate-600 p-2 rounded-xl text-[10px] font-black uppercase mt-2 border border-slate-600">üñ®Ô∏è Print KOT</button>
                    </div>

                    ${isAsked ? '<div class="absolute top-2 right-2 animate-bounce bg-red-600 text-[8px] px-2 py-1 rounded font-black">CUSTOMER ASKING!</div>' : ''}
                </div>`;
            }).join('');
        }

        async function updateStatus(inv, newStatus) {
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: "update", invoice_no: inv, new_status: newStatus })
                });
                
                // Turant UI update karne ke liye
                fetchOrders(); 
                
                if(newStatus === 'Served' || newStatus === 'Rejected') {
                    alert("Order removed from active list.");
                }
            } catch (e) { alert("Update failed!"); }
        }

        function printKOT(inv, name, table, items) {
            const printArea = document.getElementById('print-area');
            const time = new Date().toLocaleTimeString();
            printArea.innerHTML = `
                <div class="kot-card">
                    <center><h2>HOTEL VIJAY - KOT</h2></center>
                    <hr>
                    <p><b>TABLE: ${table}</b> | <b>INV: #${inv}</b></p>
                    <p>NAME: ${name} | TIME: ${time}</p>
                    <hr>
                    <div style="font-size: 16px; font-weight: bold; margin: 15px 0;">
                        ${items.split(',').join('<br>')}
                    </div>
                    <hr>
                    <center><p>Growft Digital Kitchen</p></center>
                </div>
            `;
            window.print();
        }

        document.body.addEventListener('click', () => alertSound.play().then(() => alertSound.pause()), {once: true});
        setInterval(fetchOrders, 7000);
        fetchOrders();
    </script>
</body>
</html>
